project: werf-guide-app
configVersion: 1

---
image: builder
from: node:12-alpine
git:
- add: /
  to: /app
  includePaths:
  - package.json 
  - package-lock.json
  stageDependencies:
  - install
- add: /
  to: /app
  stageDependencies:
  - setup
shell:
  install:
  - npm ci
  setup:
  - npm build

---
image: backend
from: node:12-alpine
docker:
  WORKDIR: /app
git:
- add: /
  to: /app
  includePaths:
  - package.json 
  - package-lock.json
  stageDependencies:
  - install
shell:
  beforeInstall:
  - apk update
  - apk add -U mysql-client
  install:
  - npm ci --production
  setup:
  - mkdir -p /app/dist
import:
- image: builder
  add: /app/dist/*.html
  to: /app/dist
  after: setup
- image: builder
  add: /app/app.js
  to: /app/app.js
  after: setup
- image: builder
  add: /app/bin
  to: /app/bin
  after: setup
- image: builder
  add: /app/routes
  to: /app/routes
  after: setup
- image: builder
  add: /app/config
  to: /app/config
  after: setup
- image: builder
  add: /app/db
  to: /app/db
  after: setup
- image: builder
  add: /app/.sequelizerc
  to: /app/.sequelizerc
  after: setup

---
image: frontend
from: nginx:stable-alpine
docker:
  WORKDIR: /www
git:
- add: /.werf/nginx.conf
  to: /etc/nginx/nginx.conf
import:
- image: builder
  add: /app/dist
  to: /www/static
  after: install
